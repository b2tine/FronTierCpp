#!/bin/bash

#SBATCH --job-name=mpi_job_test-3d-%j   # Job name
#SBATCH --ntasks=8                      # Number of MPI tasks (i.e. processes
#SBATCH --cpus-per-task=1               # Number of cores per MPI task
#SBATCH --nodes=1                       # Maximum number of nodes to be allocated
#SBATCH --mem-per-cpu=6G                # memory per cpu-core
#SBATCH --output=mpi_test_%j.log        # Path to the standard output and error files relative to the working directory


EXE="cairfoil"
DIR=$(pwd)


if [ "$#" -ne 1 ]; then
    echo "Error: must provide input file as argument"
    exit -1;
fi

INFILE=$1
BASENAME=${INFILE#in-}
OUTDIR="out-${BASENAME}-p222"


echo "Date              = $(date)"
echo "Hostname          = $(hostname -s)"
echo "Working Directory = $DIR"
echo "Executable = $EXE"
echo "Input File = $INFILE"
echo "Output Directory = $OUTDIR"
echo ""
echo "Number of Nodes Allocated      = $SLURM_JOB_NUM_NODES"
echo "Number of Tasks Allocated      = $SLURM_NTASKS"
echo "Number of Cores/Task Allocated = $SLURM_CPUS_PER_TASK"
echo ""


module load mvapich2/2.3.3-gcc-8.3.1
#export LD_LIBRARY_PATH="/opt/sundials/sundials-2.7.0-opt/lib:/opt/petsc/petsc-3.13.4-opt/lib:/usr/lib64:$LD_LIBRARY_PATH"

echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
echo ""

echo "mpiexec -np 8 $DIR/$EXE -d 3 -p 2 2 2 -i $DIR/$INFILE -o $OUTDIR"


mpiexec -np 8 $DIR/$EXE -d 3 -p 2 2 2 -i $DIR/$INFILE -o $OUTDIR


